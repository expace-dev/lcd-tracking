{% extends 'base.html.twig' %}
{% block title %}Logements
{% endblock %}

{% block body %}
	<section class="section">
		<div class="container">

			<header class="section-header">
				<h2>Logements</h2>
				<p class="subtle">Gérez vos logements et l’intervenant assigné.</p>
			</header>

			{# Flash messages #}
			{% for message in app.flashes('success') %}
				<p class="form-success" role="status">{{ message }}</p>
			{% endfor %}
			{% for message in app.flashes('error') %}
				<p class="form-error" role="status">{{ message }}</p>
			{% endfor %}

			<div class="cta-row">
				<a class="btn btn-primary" href="{{ path('owner_properties_new') }}">Ajouter un logement</a>
				<a class="btn btn-secondary" href="{{ path('owner_dashboard') }}">Retour dashboard</a>
			</div>

			<div class="stack" style="margin-top: 16px;">
				{% for property in properties %}
					<div class="card">
						<h3 style="margin-bottom: 6px;">{{ property.name }}</h3>

						<p class="subtle" style="margin: 0;">
							Intervenant :
							{% if property.assignedWorker %}
								<strong>{{ property.assignedWorker.fullName }}</strong>
								—
								{{ property.assignedWorker.phone }}
							{% else %}
								<span class="badge badge--warning">Non assigné</span>
							{% endif %}
						</p>

						<div class="cta-row" style="margin-top: 12px;">
							<a class="btn btn-secondary" href="{{ path('owner_properties_edit', {id: property.id}) }}">Gérer</a>

							<form method="post" action="{{ path('owner_properties_delete', {id: property.id}) }}" onsubmit="return confirm('Supprimer ce logement ? Toutes les interventions seront supprimées.');">
								<input type="hidden" name="_token" value="{{ csrf_token('delete_property_' ~ property.id) }}">
								<button class="btn btn-secondary" type="submit">Supprimer</button>
							</form>
						</div>

						{% if property.assignedWorker %}
							<div style="margin-top: 10px;">
								<p class="subtle" style="margin: 0 0 6px;">Lien intervenant :</p>
								<div class="worker-link" data-controller="clipboard" data-clipboard-text-value="{{ absolute_url(path('worker_access', { token: property.assignedWorker.accessToken })) }}">

									<button type="button" class="btn btn-secondary" data-action="clipboard#copy">
										Copier le lien intervenant
									</button>

									<span class="worker-link__feedback" data-clipboard-target="feedback" aria-live="polite"></span>
								</div>
							</div>
						{% endif %}
					</div>
				{% else %}
					<div class="card">
						<h3>Aucun logement</h3>
						<p class="subtle">Ajoutez votre premier logement pour démarrer.</p>
						<div class="cta-row" style="margin-top: 12px;">
							<a class="btn btn-primary" href="{{ path('owner_properties_new') }}">Créer mon premier logement</a>
						</div>
					</div>
				{% endfor %}
			</div>

		</div>
	</section>
{% endblock %}
